name: Deploy Coinbase Daily Data Extractor

on:
  push:
    branches: [develop, main]
    paths:
      - 'coinbase-lambda/**'
  workflow_dispatch:

env:
  AWS_REGION: eu-west-2
  ECR_REPOSITORY: coinbase-daily-extractor
  LAMBDA_FUNCTION_NAME: coinbase-daily-data-extractor
  LAMBDA_TIMEOUT: 900  # 15 minutes
  LAMBDA_MEMORY: 2048  # 2GB for data processing

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Need at least 2 commits for change detection
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Run basic tests
      run: |
        cd coinbase-lambda
        python -c "import json; print('Basic test passed')"
    
    - name: Test Docker build
      run: |
        cd coinbase-lambda
        docker build -t coinbase-daily-extractor .
        echo "Docker build successful"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Need at least 2 commits for change detection
    
    - name: Set environment
      id: set-env
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "environment=production" >> $GITHUB_OUTPUT
        else
          echo "environment=develop" >> $GITHUB_OUTPUT
        fi
        echo "Deploying to environment: ${{ steps.set-env.outputs.environment }}"
    
    - name: Check for changes
      id: changes
      run: |
        # Check what files changed in coinbase-lambda/ directory
        # For first deployment or workflow_dispatch, assume everything changed
        if [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "$(git rev-list --count HEAD)" -eq 1 ]; then
          echo "First deployment or manual trigger - assuming all changes"
          echo "requirements_changed=true" >> $GITHUB_OUTPUT
          echo "function_changed=true" >> $GITHUB_OUTPUT
        else
          # Get changed files in coinbase-lambda/ directory
          CHANGED_FILES=$(git diff --name-only HEAD~1 | grep "^coinbase-lambda/" || true)
          echo "Changed files in coinbase-lambda/: $CHANGED_FILES"
          
          # Check if requirements.txt changed
          if echo "$CHANGED_FILES" | grep -q "requirements.txt"; then
            echo "requirements_changed=true" >> $GITHUB_OUTPUT
            echo "Requirements.txt changed - will rebuild Docker image"
          else
            echo "requirements_changed=false" >> $GITHUB_OUTPUT
            echo "Requirements.txt unchanged - will skip Docker build if possible"
          fi
          
          # Check if function code changed (Python files, Dockerfile, or any other code)
          if echo "$CHANGED_FILES" | grep -q "\.py\|Dockerfile"; then
            echo "function_changed=true" >> $GITHUB_OUTPUT
            echo "Function code changed - will update Lambda function"
          else
            echo "function_changed=false" >> $GITHUB_OUTPUT
            echo "Function code unchanged - will skip Lambda update"
          fi
        fi
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
    
    - name: Setup ECR Repository
      run: |
        # Check if repository exists
        if ! aws ecr describe-repositories --repository-names ${{ env.ECR_REPOSITORY }} --region ${{ env.AWS_REGION }} 2>/dev/null; then
          echo "Creating ECR repository..."
          aws ecr create-repository --repository-name ${{ env.ECR_REPOSITORY }} --region ${{ env.AWS_REGION }}
        fi
        
        # Set repository policy for Lambda access
        aws ecr set-repository-policy \
          --repository-name ${{ env.ECR_REPOSITORY }} \
          --region ${{ env.AWS_REGION }} \
          --policy-text '{
            "Version": "2012-10-17",
            "Statement": [
              {
                "Sid": "LambdaAccess",
                "Effect": "Allow",
                "Principal": {
                  "Service": "lambda.amazonaws.com"
                },
                "Action": [
                  "ecr:BatchGetImage",
                  "ecr:GetDownloadUrlForLayer"
                ]
              }
            ]
          }'
    
    - name: Build and push Docker image (if needed)
      id: build
      if: steps.changes.outputs.requirements_changed == 'true' || steps.changes.outputs.function_changed == 'true'
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "Building and pushing Docker image..."
        cd coinbase-lambda
        docker build -t $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG .
        docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG
        echo "image_uri=$ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG" >> $GITHUB_OUTPUT
        echo "‚úÖ Docker image built and pushed successfully"
    
    - name: Set image URI
      id: image-uri
      run: |
        if [ "${{ steps.changes.outputs.requirements_changed }}" = "true" ] || [ "${{ steps.changes.outputs.function_changed }}" = "true" ]; then
          # Use newly built image
          echo "image_uri=${{ steps.build.outputs.image_uri }}" >> $GITHUB_OUTPUT
          echo "Using newly built image: ${{ steps.build.outputs.image_uri }}"
        else
          # Get the latest image URI from ECR
          LATEST_IMAGE_URI=$(aws ecr describe-images \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --region ${{ env.AWS_REGION }} \
            --query 'imageDetails[0].imageUri' \
            --output text 2>/dev/null || echo "")
          
          if [ -n "$LATEST_IMAGE_URI" ]; then
            echo "image_uri=$LATEST_IMAGE_URI" >> $GITHUB_OUTPUT
            echo "Using existing image: $LATEST_IMAGE_URI"
          else
            echo "‚ùå No existing image found - this should not happen"
            exit 1
          fi
        fi
    
    - name: Setup IAM Role and Permissions
      run: |
        # Check if IAM role exists
        if ! aws iam get-role --role-name lambda-execution-role-fintracker-v2 --region ${{ env.AWS_REGION }} 2>/dev/null; then
          echo "IAM role lambda-execution-role-fintracker-v2 does not exist. Please create it manually with the required permissions."
          echo "Required permissions:"
          echo "- logs:CreateLogGroup, logs:CreateLogStream, logs:PutLogEvents"
          echo "- s3:GetObject, s3:PutObject, s3:PutObjectAcl (for hashadar-personalfinance bucket)"
          echo "- ecr:GetAuthorizationToken, ecr:BatchCheckLayerAvailability, ecr:GetDownloadUrlForLayer, ecr:BatchGetImage"
          exit 1
        fi
        
        echo "IAM role exists, proceeding with deployment"
    
    - name: Deploy Lambda Function (if needed)
      if: steps.changes.outputs.function_changed == 'true'
      run: |
        # Check if function exists
        if aws lambda get-function --function-name ${{ env.LAMBDA_FUNCTION_NAME }} --region ${{ env.AWS_REGION }} 2>/dev/null; then
          echo "Updating existing Lambda function..."
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --image-uri "${{ steps.image-uri.outputs.image_uri }}" \
            --region ${{ env.AWS_REGION }}
          
          # Wait for function code update to complete
          echo "Waiting for function code update to complete..."
          aws lambda wait function-updated --function-name ${{ env.LAMBDA_FUNCTION_NAME }} --region ${{ env.AWS_REGION }}
          
          # Now update function configuration
          echo "Updating function configuration..."
          aws lambda update-function-configuration \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --timeout ${{ env.LAMBDA_TIMEOUT }} \
            --memory-size ${{ env.LAMBDA_MEMORY }} \
            --region ${{ env.AWS_REGION }} \
            --environment Variables='{ENVIRONMENT=${{ steps.set-env.outputs.environment }},S3_BUCKET_NAME=hashadar-personalfinance}'
          
          # Wait for configuration update to complete
          echo "Waiting for function configuration update to complete..."
          aws lambda wait function-updated --function-name ${{ env.LAMBDA_FUNCTION_NAME }} --region ${{ env.AWS_REGION }}
        else
          echo "Creating new Lambda function..."
          aws lambda create-function \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --package-type Image \
            --code ImageUri="${{ steps.image-uri.outputs.image_uri }}" \
            --role arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/lambda-execution-role-fintracker-v2 \
            --timeout ${{ env.LAMBDA_TIMEOUT }} \
            --memory-size ${{ env.LAMBDA_MEMORY }} \
            --region ${{ env.AWS_REGION }} \
            --environment Variables='{ENVIRONMENT=${{ steps.set-env.outputs.environment }},S3_BUCKET_NAME=hashadar-personalfinance}'
          
          # Wait for function creation to complete
          echo "Waiting for function creation to complete..."
          aws lambda wait function-active --function-name ${{ env.LAMBDA_FUNCTION_NAME }} --region ${{ env.AWS_REGION }}
        fi
        echo "‚úÖ Lambda function updated successfully"
    
    - name: Test Lambda Function
      run: |
        # Function should already be ready from previous step
        echo "Testing Lambda function..."
        
        # Create test payload
        echo '{"test": "data"}' | base64 > test-payload.b64
        
        # Invoke function
        aws lambda invoke \
          --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
          --payload file://test-payload.b64 \
          --region ${{ env.AWS_REGION }} \
          response.json
        
        # Check response
        if [ -f response.json ]; then
          echo "Lambda function response:"
          cat response.json
          
          # Check if response contains success
          if grep -q '"statusCode": 200' response.json; then
            echo "‚úÖ Lambda function test successful"
          else
            echo "‚ùå Lambda function test failed"
            exit 1
          fi
        else
          echo "‚ùå No response file generated"
          exit 1
        fi
    
    - name: Setup EventBridge Rule
      run: |
        echo "Starting EventBridge rule setup..."
        
        # Check if rule exists (with better error handling)
        RULE_EXISTS=false
        if aws events describe-rule --name coinbase-daily-extraction-rule --region ${{ env.AWS_REGION }} 2>/dev/null; then
          echo "EventBridge rule 'coinbase-daily-extraction-rule' already exists"
          RULE_EXISTS=true
        else
          echo "EventBridge rule 'coinbase-daily-extraction-rule' does not exist, creating it..."
        fi
        
        if [ "$RULE_EXISTS" = false ]; then
          echo "Creating EventBridge rule for daily execution at 2am UTC..."
          aws events put-rule \
            --name coinbase-daily-extraction-rule \
            --schedule-expression "cron(0 2 * * ? *)" \
            --region ${{ env.AWS_REGION }}
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ EventBridge rule created successfully"
          else
            echo "‚ùå Failed to create EventBridge rule"
            exit 1
          fi
        fi
        
        echo "Configuring EventBridge target..."
        # Add/Update Lambda as target
        aws events put-targets \
          --rule coinbase-daily-extraction-rule \
          --targets "Id"="1","Arn"="arn:aws:lambda:${{ env.AWS_REGION }}:${{ secrets.AWS_ACCOUNT_ID }}:function:${{ env.LAMBDA_FUNCTION_NAME }}" \
          --region ${{ env.AWS_REGION }}
        
        if [ $? -eq 0 ]; then
          echo "‚úÖ EventBridge target configured successfully"
        else
          echo "‚ùå Failed to configure EventBridge target"
          exit 1
        fi
        
        echo "Checking EventBridge permissions..."
        # Check if permission exists, if not add it
        if ! aws lambda get-policy --function-name ${{ env.LAMBDA_FUNCTION_NAME }} --region ${{ env.AWS_REGION }} 2>/dev/null | grep -q "EventBridgeInvoke"; then
          echo "Adding EventBridge permission..."
          aws lambda add-permission \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --statement-id EventBridgeInvoke \
            --action lambda:InvokeFunction \
            --principal events.amazonaws.com \
            --source-arn "arn:aws:events:${{ env.AWS_REGION }}:${{ secrets.AWS_ACCOUNT_ID }}:rule/coinbase-daily-extraction-rule" \
            --region ${{ env.AWS_REGION }}
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ EventBridge permission added successfully"
          else
            echo "‚ùå Failed to add EventBridge permission"
            exit 1
          fi
        else
          echo "‚úÖ EventBridge permission already exists"
        fi
        
        echo "üéâ EventBridge rule setup completed successfully!" 